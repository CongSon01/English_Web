<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SheetBest API Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            max-height: 300px;
        }
    </style>
</head>
<body>
    <h1>SheetBest API Integration Test</h1>
    <p>Current date: <strong>May 30, 2025</strong></p>
    
    <div class="test-section">
        <h2>1. API Connectivity Test</h2>
        <button onclick="testAPIConnection()">Test GET Request</button>
        <div id="connectivity-result"></div>
    </div>

    <div class="test-section">
        <h2>2. Data Structure Test</h2>
        <button onclick="testDataStructure()">Test Data Format</button>
        <div id="structure-result"></div>
    </div>

    <div class="test-section">
        <h2>3. Today's Vocabulary Filter Test</h2>
        <button onclick="testTodayFilter()">Test Today's Words (May 30, 2025)</button>
        <div id="filter-result"></div>
    </div>

    <div class="test-section">
        <h2>4. CRUD Operations Test</h2>
        <button onclick="testCRUDOperations()">Test Add/Update/Delete</button>
        <div id="crud-result"></div>
    </div>

    <div class="test-section">
        <h2>5. Application Integration Test</h2>
        <button onclick="testApplicationIntegration()">Test Full Integration</button>
        <div id="integration-result"></div>
    </div>

    <script>
        const SHEETBEST_API_URL = 'https://api.sheetbest.com/sheets/4e6412d1-956d-4f38-844a-7451bb94faa2';
        
        function addResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = message;
            container.appendChild(resultDiv);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        async function testAPIConnection() {
            clearResults('connectivity-result');
            addResult('connectivity-result', 'Testing API connection...', 'info');

            try {
                const response = await fetch(SHEETBEST_API_URL, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    addResult('connectivity-result', `‚úÖ API Connection Successful! Status: ${response.status}`, 'success');
                    addResult('connectivity-result', `üìä Data rows received: ${data.length}`, 'success');
                    addResult('connectivity-result', `<pre>${JSON.stringify(data[0] || {}, null, 2)}</pre>`, 'info');
                } else {
                    addResult('connectivity-result', `‚ùå API Error: ${response.status} - ${response.statusText}`, 'error');
                }
            } catch (error) {
                addResult('connectivity-result', `‚ùå Connection Failed: ${error.message}`, 'error');
            }
        }

        async function testDataStructure() {
            clearResults('structure-result');
            addResult('structure-result', 'Testing data structure...', 'info');

            try {
                const response = await fetch(SHEETBEST_API_URL, { method: 'GET' });
                const data = await response.json();

                if (data.length === 0) {
                    addResult('structure-result', '‚ö†Ô∏è No data found in API', 'error');
                    return;
                }

                const firstItem = data[0];
                const requiredFields = ['Vietnamese', 'English', 'Created_date', 'Next_date', 'Status'];
                const missingFields = requiredFields.filter(field => !firstItem.hasOwnProperty(field));

                if (missingFields.length === 0) {
                    addResult('structure-result', '‚úÖ All required fields present', 'success');
                } else {
                    addResult('structure-result', `‚ùå Missing fields: ${missingFields.join(', ')}`, 'error');
                }

                addResult('structure-result', `üìã Available fields: ${Object.keys(firstItem).join(', ')}`, 'info');
                
                // Test date format
                const dateFormat = /^\d{2}\/\d{2}\/\d{4}$/;
                const hasValidDate = dateFormat.test(firstItem.Next_date);
                addResult('structure-result', hasValidDate ? '‚úÖ Date format is correct (DD/MM/YYYY)' : '‚ùå Date format issue', hasValidDate ? 'success' : 'error');

            } catch (error) {
                addResult('structure-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testTodayFilter() {
            clearResults('filter-result');
            addResult('filter-result', 'Testing today\'s vocabulary filter...', 'info');

            try {
                const response = await fetch(SHEETBEST_API_URL, { method: 'GET' });
                const data = await response.json();

                const today = '30/05/2025'; // May 30, 2025
                const todayWords = data.filter(word => {
                    const nextDate = word.Next_date;
                    const isToday = nextDate === today;
                    const hasValidStatus = word.Status && ['Easy', 'Medium', 'Hard'].includes(word.Status);
                    return isToday && hasValidStatus;
                });

                addResult('filter-result', `üìä Total words in database: ${data.length}`, 'info');
                addResult('filter-result', `üìÖ Words for today (${today}): ${todayWords.length}`, 'success');

                if (todayWords.length > 0) {
                    addResult('filter-result', '‚úÖ Found words for today!', 'success');
                    addResult('filter-result', `<pre>${JSON.stringify(todayWords.slice(0, 3), null, 2)}</pre>`, 'info');
                } else {
                    addResult('filter-result', '‚ö†Ô∏è No words scheduled for today. Check your date settings.', 'error');
                    
                    // Show some example dates in the data
                    const uniqueDates = [...new Set(data.map(w => w.Next_date))].slice(0, 5);
                    addResult('filter-result', `üìÖ Example dates in data: ${uniqueDates.join(', ')}`, 'info');
                }

            } catch (error) {
                addResult('filter-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testCRUDOperations() {
            clearResults('crud-result');
            addResult('crud-result', 'Testing CRUD operations...', 'info');

            try {
                // Test GET
                const getResponse = await fetch(SHEETBEST_API_URL, { method: 'GET' });
                const originalData = await getResponse.json();
                addResult('crud-result', `‚úÖ GET: Retrieved ${originalData.length} records`, 'success');

                // Test POST (Add new record)
                const testWord = {
                    Vietnamese: "Test t·ª´",
                    Note: "Test note",
                    English: "Test word",
                    Image_link: "",
                    Created_date: "30/05/2025",
                    Next_date: "31/05/2025",
                    Status: "Easy",
                    Count: 0
                };

                addResult('crud-result', 'üîÑ Testing POST operation...', 'info');
                const postResponse = await fetch(SHEETBEST_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify([testWord])
                });

                if (postResponse.ok) {
                    addResult('crud-result', '‚úÖ POST: Successfully added test record', 'success');
                    
                    // Verify the addition
                    const verifyResponse = await fetch(SHEETBEST_API_URL, { method: 'GET' });
                    const newData = await verifyResponse.json();
                    
                    if (newData.length > originalData.length) {
                        addResult('crud-result', `‚úÖ VERIFY: Record count increased (${originalData.length} ‚Üí ${newData.length})`, 'success');
                    } else {
                        addResult('crud-result', '‚ö†Ô∏è VERIFY: Record count unchanged', 'error');
                    }
                } else {
                    addResult('crud-result', `‚ùå POST failed: ${postResponse.status}`, 'error');
                }

            } catch (error) {
                addResult('crud-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testApplicationIntegration() {
            clearResults('integration-result');
            addResult('integration-result', 'Testing application integration...', 'info');

            try {
                // Simulate the fetchVocabularyData function
                const response = await fetch(SHEETBEST_API_URL, { 
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`API error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Process the data like the app does
                const processedData = data.map(item => ({
                    Vietnamese: item.Vietnamese || '',
                    Note: item.Note || '',
                    English: item.English || '',
                    Image_link: item.Image_link || '',
                    Created_date: item.Created_date || '',
                    Next_date: item.Next_date || '',
                    Status: item.Status || 'Easy',
                    Count: parseInt(item.Count) || 0
                }));

                addResult('integration-result', `‚úÖ Data processing successful: ${processedData.length} records`, 'success');

                // Test filtering like the app does
                const today = '30/05/2025';
                const todayWords = processedData.filter(word => {
                    const nextDate = word.Next_date;
                    const isToday = nextDate === today;
                    const hasValidStatus = word.Status && ['Easy', 'Medium', 'Hard'].includes(word.Status);
                    return isToday && hasValidStatus;
                });

                addResult('integration-result', `üìÖ Today's vocabulary: ${todayWords.length} words`, 'success');

                if (todayWords.length > 0) {
                    addResult('integration-result', '‚úÖ Application should load successfully with today\'s words!', 'success');
                } else {
                    addResult('integration-result', '‚ö†Ô∏è Application will show "No words for today" message', 'error');
                }

                // Test localStorage simulation
                try {
                    localStorage.setItem('vocabularyData', JSON.stringify(processedData));
                    localStorage.setItem('lastSaveDate', new Date().toISOString());
                    addResult('integration-result', '‚úÖ localStorage simulation successful', 'success');
                } catch (storageError) {
                    addResult('integration-result', '‚ö†Ô∏è localStorage test failed', 'error');
                }

            } catch (error) {
                addResult('integration-result', `‚ùå Integration test failed: ${error.message}`, 'error');
            }
        }

        // Auto-run basic connectivity test on load
        window.addEventListener('load', () => {
            testAPIConnection();
        });
    </script>
</body>
</html>
